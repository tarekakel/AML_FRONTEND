<div class="p-4 bg-white rounded-2xl shadow-md">

  <div class="mb-6 p-4 bg-white shadow rounded-2xl">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-6">

      <!-- Title -->
      <h2 class="text-xl font-semibold text-gray-800">Filters</h2>

      <!-- Filters row -->
      <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">

        <!-- Search -->
        <div class="flex flex-col w-full sm:w-64">
          <label class="text-sm text-gray-600 mb-1">Search</label>
          <input type="text" placeholder="Email or username..." [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <!-- From Date -->
        <div class="flex flex-col w-full sm:w-40">
          <label class="text-sm text-gray-600 mb-1">From Date</label>
          <input type="text" bsDatepicker [bsConfig]="bsConfig" [(ngModel)]="startdate" placeholder="Select..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <!-- To Date -->
        <div class="flex flex-col w-full sm:w-40">
          <label class="text-sm text-gray-600 mb-1">To Date</label>
          <input type="text" bsDatepicker [bsConfig]="bsConfig" [(ngModel)]="enddate" placeholder="Select..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <!--  -->
        <!-- Action button -->
        <div class="flex items-end">
          <button (click)="applyFilters()"
            class="flex items-center px-5 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
            <!-- Filter Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-5 h-5 mr-2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 13.414V20a1 1 0 01-1.447.894l-4-2A1 1 0 019 18v-4.586L3.293 6.707A1 1 0 013 6V4z" />
            </svg>

            Search
          </button>
        </div>
        <div class="flex items-end">
          <button (click)="exportAll(null)"
            class="flex items-center px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
            <!-- Export Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-5 h-5 mr-2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M7.5 10.5L12 15m0 0l4.5-4.5M12 15V3" />
            </svg>
            Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div *ngIf="!isLoading">
    <ng-container *ngIf="rows.length > 0; else noData">
      <table class="min-w-full table-auto border-collapse">


        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
          <tr>
            <!-- <th class="px-4 py-2 text-left">ID</th> -->
            <th class="px-4 py-2 text-left">First Name</th>
            <th class="px-4 py-2 text-left">Last Name</th>
            <th class="px-4 py-2 text-left">Nationality</th>
            <th class="px-4 py-2 text-left">Created User</th>
            <th class="px-4 py-2 text-left">Created Date</th>
            <th class="px-4 py-2 text-left">No Of Matches</th>

            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let row of rows;  trackBy: trackByRowId">
            <!-- Main Row -->
            <tr class="border-b hover:bg-gray-50">
              <!-- <td class="px-4 py-2">{{ row.id }}</td> -->
              <td class="px-4 py-2">{{ row.first_name }}</td>
              <td class="px-4 py-2">{{ row.last_name }}</td>
              <td class="px-4 py-2">{{ row.nationality }}</td>

              <td class="px-4 py-2">{{ row.created_by }}</td>
              <td class="px-4 py-2">{{ row.create_dt | date:'short' }}</td>
              <td class="px-4 py-2">{{ row.result_count }}</td>
              <td class="px-4 py-2 text-right">
                <button (click)="toggleExpand(row)" class="text-blue-600 hover:underline focus:outline-none">
                  {{ expanded.has(row.id) ? '▼' : '▶' }}
                </button>
                <button (click)="exportAll(row.id)" class="text-green-600 hover:underline focus:outline-none"
                  title="Export">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M7.5 10.5L12 15m0 0l4.5-4.5M12 15V3" />
                  </svg>
                </button>
              </td>
            </tr>

            <!-- Expanded Child Row -->
            <tr *ngIf="expanded.has(row.id)" class="bg-gray-50">
              <td colspan="7" class="p-0">
                <div class="relative max-h-48 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400">
                  <table class="min-w-full bg-white border border-gray-200 border-collapse table-auto">
                    <thead class="bg-gradient-to-r from-blue-100 to-indigo-100">
                      <tr>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          First
                          Name
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Last
                          Name
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Nationality
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Created Date
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Status
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Action
                          By
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Date Of
                          Birth
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Total
                          Score
                        </th>
                        <th
                          class="sticky top-0 z-10 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide border-b border-gray-200 bg-gradient-to-r from-blue-100 to-indigo-100">
                          Notes

                        </th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      <tr *ngFor="let child of   row.results ;trackByChildId"
                        class="hover:bg-blue-50 transition-colors duration-150">
                        <td class="px-4 py-2">{{ child.first_name }}</td>
                        <td class="px-4 py-2">{{ child.last_name }}</td>
                        <td class="px-4 py-2">{{ child.nationality }}</td>
                        <td class="px-4 py-2">{{ child.create_dt |date:'short' }}</td>
                        <td class="px-4 py-2">
                          <span class="inline-block px-2 py-1 text-xs font-medium rounded-full uppercase"
                            [ngClass]="getStatusBadgeClasses(child.status)">
                            {{ child.status }}
                          </span>
                        </td>
                        <td class="px-4 py-2 text-center">
                          {{ child.auto_reject ? 'Auto Reject (system)': child?.action_by }}
                        </td>

                        <td class="px-4 py-2 text-gray-600">
                          {{ child.date_of_birth | date:'mediumDate' }}
                        </td>
                        <td>
                          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full"
                            [ngClass]="getScoreClasses(child.total_score)">
                            {{ formatPct(child.total_score) }}
                          </span>
                        </td>
                        <td>
                          {{child.notes}}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </ng-container>
    <ng-template #noData>
      <div class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9 17v-4h6v4m2 4H7a2 2 0 01-2-2V7a2 2 0 012-2h5l2 2h5a2 2 0 012 2v12a2 2 0 01-2 2z" />
        </svg>
        <p class="mt-4 text-gray-500 text-lg font-medium">No records found</p>
        <p class="mt-1 text-gray-400 text-sm">Try adjusting your filters or date range</p>
      </div>
    </ng-template>
    <app-loader *ngIf="isLoading"></app-loader>
    <!-- Pagination Controls -->
    <div class="flex items-center justify-between mt-4">
      <button (click)="prevPage()" [disabled]="meta.page === 1"
        class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">
        Previous
      </button>

      <span>Page {{ meta.page }} of {{ meta.totalPages }}</span>

      <button (click)="nextPage()" [disabled]="meta.page === meta.totalPages"
        class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">
        Next
      </button>
    </div>
  </div>